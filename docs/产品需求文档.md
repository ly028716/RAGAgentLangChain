# AI智能助手系统 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目背景
开发一个基于大语言模型的智能助手系统，集成RAG（检索增强生成）、Agent（智能代理）等先进AI技术，为用户提供智能问答、知识检索、任务执行等服务。

### 1.2 项目目标
- 构建前后端分离的AI应用系统
- 实现基于通义千问大模型的智能对话能力
- 提供RAG技术支持的知识库问答功能
- 开发具备工具调用能力的Agent系统
- 提供友好的Web交互界面

### 1.3 技术架构
- **前端**: Vue 3.js + TypeScript + Vite
- **后端**: Python + FastAPI + LangChain 1.0
- **数据库**: MySQL (本地部署)
- **AI模型**: 通义千问大模型
- **向量数据库**: Chroma/Milvus
- **缓存**: Redis

---

## 2. 功能需求

### 2.1 用户管理模块

#### 2.1.1 用户注册
- 支持邮箱/手机号注册
- 密码强度验证
- 邮箱/短信验证码验证
- 用户协议确认

#### 2.1.2 用户登录
- 账号密码登录
- JWT Token认证
- 记住登录状态（7天）
- 登录日志记录

#### 2.1.3 用户信息管理
- 查看个人信息
- 修改昵称、头像
- 修改密码
- 账号注销

### 2.2 智能对话模块

#### 2.2.1 基础对话功能
- 支持多轮对话
- 实时流式输出
- 对话历史记录
- 上下文理解能力
- 支持Markdown格式渲染
- 代码高亮显示

#### 2.2.2 对话管理
- 创建新对话
- 查看历史对话列表
- 删除对话记录
- 重命名对话标题
- 导出对话内容

#### 2.2.3 对话配置
- 模型参数调整（温度、最大长度等）
- 系统提示词自定义
- 对话模式切换（普通/专业/创意）

### 2.3 知识库管理模块（RAG）

#### 2.3.1 知识库创建
- 创建知识库
- 设置知识库名称、描述
- 知识库分类管理
- 知识库权限设置

#### 2.3.2 文档管理
- 支持文档上传（PDF、Word、TXT、Markdown）
- 文档列表展示
- 文档预览
- 文档删除
- 批量上传
- 文档状态跟踪（处理中/已完成/失败）

#### 2.3.3 文档处理
- 自动文本提取
- 智能分块处理
- 向量化存储
- 元数据管理

#### 2.3.4 知识库问答
- 基于知识库的智能问答
- 相关文档片段展示
- 来源引用标注
- 相似度评分显示
- 支持多知识库联合检索

### 2.4 Agent智能代理模块

#### 2.4.1 Agent能力
- 任务理解与分解
- 工具自动选择与调用
- 多步推理执行
- 执行结果反馈

#### 2.4.2 内置工具集
系统预置6种内置工具，用户可直接使用，无需配置：

**基础工具**
- **计算器工具（calculator）**：执行数学计算，支持基本算术运算和数学函数（加减乘除、幂运算、三角函数等）
- **网络搜索工具（search）**：在互联网上搜索信息，获取最新的网络内容
- **天气查询工具（weather）**：查询指定城市的天气信息，包括温度、湿度、天气状况等

**高级工具**
- **文件操作工具（file_operations）**：执行文件系统操作，包括读取文件、写入文件、列出目录、检查文件存在性。限制在安全的工作目录内操作
- **数据分析工具（data_analysis）**：对JSON格式数据进行分析和处理，支持统计分析、数据过滤、聚合计算、排序等操作
- **API调用工具（api_call）**：调用外部API接口，支持HTTP GET/POST/PUT/DELETE/PATCH请求，可用于集成第三方服务

#### 2.4.3 工具管理
- 工具列表展示（显示所有内置工具）
- 工具启用/禁用管理
- 工具描述和使用说明
- 工具状态监控

**设计说明**：
- 系统只提供内置工具，不支持用户自定义工具创建
- 内置工具由系统管理员通过种子数据脚本初始化
- 用户只能启用或禁用工具，不能修改或删除内置工具
- 这种设计确保了工具的安全性、稳定性和易用性

#### 2.4.4 任务执行
- 任务提交
- 执行过程可视化
- 中间步骤展示（Thought、Action、Observation）
- 执行日志记录
- 任务结果导出
- 支持流式和非流式两种执行模式

### 2.5 系统管理模块

#### 2.5.1 API密钥管理
- 通义千问API密钥配置
- 密钥有效性验证
- 使用量统计
- 密钥安全存储

#### 2.5.2 系统配置
- 模型参数全局配置
- 向量数据库配置
- 缓存配置
- 日志级别设置

#### 2.5.3 使用统计
- Token消耗统计
- API调用次数统计
- 用户活跃度分析
- 功能使用热度分析

---

## 3. 非功能需求

### 3.1 性能要求
- 对话响应时间 < 3秒（首字输出）
- 文档上传处理时间 < 30秒/MB
- 系统并发支持 ≥ 100用户
- 数据库查询响应 < 500ms
- 向量检索响应 < 1秒

### 3.2 安全要求
- 用户密码加密存储（bcrypt）
- API接口JWT认证
- SQL注入防护
- XSS攻击防护
- CSRF防护
- API密钥加密存储
- 敏感数据传输HTTPS加密

### 3.3 可用性要求
- 系统可用性 ≥ 99%
- 支持7×24小时运行
- 异常自动恢复机制
- 完善的错误提示
- 操作日志记录

### 3.4 兼容性要求
- 支持Chrome、Firefox、Safari、Edge最新版本
- 响应式设计，支持PC端和移动端
- 最低分辨率支持：1366×768

### 3.5 可扩展性要求
- 模块化设计，便于功能扩展
- 支持多种大模型切换
- 支持插件化工具扩展
- 支持多语言国际化

---

## 4. 数据库设计

### 4.1 核心数据表

#### users（用户表）
```sql
- id: 主键
- username: 用户名（唯一）
- email: 邮箱（唯一）
- password_hash: 密码哈希
- avatar: 头像URL
- created_at: 创建时间
- updated_at: 更新时间
- last_login: 最后登录时间
- is_active: 是否激活
```

#### conversations（对话表）
```sql
- id: 主键
- user_id: 用户ID（外键）
- title: 对话标题
- created_at: 创建时间
- updated_at: 更新时间
- is_deleted: 是否删除
```

#### messages（消息表）
```sql
- id: 主键
- conversation_id: 对话ID（外键）
- role: 角色（user/assistant/system）
- content: 消息内容
- tokens: Token消耗
- created_at: 创建时间
```

#### knowledge_bases（知识库表）
```sql
- id: 主键
- user_id: 用户ID（外键）
- name: 知识库名称
- description: 描述
- category: 分类
- created_at: 创建时间
- updated_at: 更新时间
```

#### documents（文档表）
```sql
- id: 主键
- knowledge_base_id: 知识库ID（外键）
- filename: 文件名
- file_path: 文件路径
- file_size: 文件大小
- file_type: 文件类型
- status: 处理状态
- chunk_count: 分块数量
- created_at: 创建时间
```

#### agent_tools（Agent工具表）
```sql
- id: 主键
- name: 工具名称
- description: 工具描述
- tool_type: 工具类型（内置/自定义）
- config: 工具配置（JSON）
- is_enabled: 是否启用
- created_at: 创建时间
```

#### agent_executions（Agent执行记录表）
```sql
- id: 主键
- user_id: 用户ID（外键）
- task: 任务描述
- steps: 执行步骤（JSON）
- result: 执行结果
- status: 执行状态
- created_at: 创建时间
- completed_at: 完成时间
```

#### api_usage（API使用记录表）
```sql
- id: 主键
- user_id: 用户ID（外键）
- api_type: API类型
- tokens_used: Token消耗
- cost: 费用
- created_at: 创建时间
```

---

## 5. API接口设计

### 5.1 用户相关接口
```
POST   /api/auth/register          # 用户注册
POST   /api/auth/login             # 用户登录
POST   /api/auth/logout            # 用户登出
GET    /api/user/profile           # 获取用户信息
PUT    /api/user/profile           # 更新用户信息
PUT    /api/user/password          # 修改密码
```

### 5.2 对话相关接口
```
POST   /api/conversations          # 创建对话
GET    /api/conversations          # 获取对话列表
GET    /api/conversations/:id      # 获取对话详情
DELETE /api/conversations/:id      # 删除对话
PUT    /api/conversations/:id      # 更新对话标题

POST   /api/chat                   # 发送消息（普通）
POST   /api/chat/stream            # 发送消息（流式）
GET    /api/messages/:conversation_id  # 获取消息历史
```

### 5.3 知识库相关接口
```
POST   /api/knowledge-bases        # 创建知识库
GET    /api/knowledge-bases        # 获取知识库列表
GET    /api/knowledge-bases/:id    # 获取知识库详情
PUT    /api/knowledge-bases/:id    # 更新知识库
DELETE /api/knowledge-bases/:id    # 删除知识库

POST   /api/documents/upload       # 上传文档
GET    /api/documents              # 获取文档列表
DELETE /api/documents/:id          # 删除文档
GET    /api/documents/:id/status   # 获取文档处理状态

POST   /api/rag/query              # RAG问答
```

### 5.4 Agent相关接口
```
GET    /api/agent/tools            # 获取工具列表（仅内置工具）
GET    /api/agent/tools/:id        # 获取工具详情
PUT    /api/agent/tools/:id        # 更新工具状态（启用/禁用）

POST   /api/agent/execute          # 执行Agent任务
POST   /api/agent/execute/stream   # 流式执行Agent任务
GET    /api/agent/executions       # 获取执行历史
GET    /api/agent/executions/:id   # 获取执行详情
```

**接口变更说明**：
- 移除了 `POST /api/agent/tools`（创建自定义工具）接口
- 移除了 `DELETE /api/agent/tools/:id`（删除工具）接口
- `PUT /api/agent/tools/:id` 仅用于启用/禁用工具，不支持修改工具配置
- 新增 `POST /api/agent/execute/stream` 支持流式任务执行

### 5.5 系统管理接口
```
GET    /api/system/config          # 获取系统配置
PUT    /api/system/config          # 更新系统配置
GET    /api/system/stats           # 获取使用统计
GET    /api/system/health          # 健康检查
```

---

## 6. 用户界面设计

### 6.1 页面结构
```
├── 登录/注册页
├── 主界面
│   ├── 侧边栏
│   │   ├── 对话列表
│   │   ├── 知识库管理
│   │   ├── Agent工具
│   │   └── 系统设置
│   ├── 主内容区
│   │   ├── 对话界面
│   │   ├── 知识库界面
│   │   └── Agent界面
│   └── 顶部导航栏
│       ├── 用户信息
│       ├── 使用统计
│       └── 帮助文档
```

### 6.2 核心页面

#### 6.2.1 对话页面
- 左侧：对话历史列表
- 中间：消息展示区域
- 底部：输入框和发送按钮
- 右侧：对话配置面板（可折叠）

#### 6.2.2 知识库页面
- 知识库列表卡片
- 文档上传区域
- 文档列表表格
- 知识库问答界面

#### 6.2.3 Agent页面
**左侧：内置工具列表**
- 工具卡片展示（图标、名称、描述）
- 工具启用/禁用开关
- 工具状态指示
- 无工具时显示初始化指引

**右侧：任务执行区域**
- 任务输入框（支持多行文本）
- 执行配置（最大迭代次数）
- 执行按钮（普通执行/流式执行）
- 执行过程可视化（时间线展示）
  - 显示每个步骤的 Thought、Action、Observation
  - 步骤标记和连接线
  - 最终结果高亮显示
- 执行历史记录（最近5条）

**设计变更说明**：
- 移除了"创建工具"按钮和工具创建对话框
- 简化为只展示内置工具，用户只能启用/禁用
- 工具列表标题从"工具列表"改为"内置工具"
- 空状态提示从"暂无工具"改为"系统内置工具未初始化"并提供初始化指引

### 6.3 交互设计要点
- 流式输出打字机效果
- 加载状态动画
- 错误提示友好
- 操作确认弹窗
- 快捷键支持
- 拖拽上传文件
- 响应式布局

---

## 7. 技术实现要点

### 7.1 前端技术栈
```
- Vue 3.js (Composition API)
- TypeScript
- Vite
- Vue Router
- Pinia (状态管理)
- Axios
- Element Plus / Ant Design Vue
- Markdown-it (Markdown渲染)
- Highlight.js (代码高亮)
- EventSource (SSE流式输出)
```

### 7.2 后端技术栈
```
- Python 3.10+
- FastAPI
- LangChain 1.0
- 通义千问 SDK (dashscope)
- SQLAlchemy (ORM)
- Alembic (数据库迁移)
- PyMySQL
- Redis
- Chroma/Milvus (向量数据库)
- python-jose (JWT)
- passlib (密码加密)
- python-multipart (文件上传)
```

### 7.3 核心技术实现

#### 7.3.1 LangChain集成
```python
from langchain_community.llms import Tongyi
from langchain.chains import ConversationalRetrievalChain
from langchain.memory import ConversationBufferMemory
from langchain.embeddings import DashScopeEmbeddings
from langchain.vectorstores import Chroma
```

#### 7.3.2 RAG实现流程
1. 文档加载 → 文本提取
2. 文本分块（RecursiveCharacterTextSplitter）
3. 向量化（DashScopeEmbeddings）
4. 存储到向量数据库
5. 用户查询 → 向量检索
6. 上下文构建 → LLM生成答案

#### 7.3.3 Agent实现
- 使用LangChain的Agent框架
- ReAct模式（推理+行动）
- 自定义工具继承BaseTool
- AgentExecutor执行任务

#### 7.3.4 流式输出
- 后端：FastAPI StreamingResponse
- 前端：EventSource接收SSE
- 实时渲染Markdown

---

## 8. 部署方案

### 8.1 开发环境
- 前端：npm run dev (Vite开发服务器)
- 后端：uvicorn main:app --reload
- MySQL：本地安装
- Redis：本地安装
- 向量数据库：Docker部署

### 8.2 生产环境
```
├── 前端
│   ├── Nginx静态文件服务
│   └── 反向代理到后端API
├── 后端
│   ├── Gunicorn + Uvicorn Workers
│   └── 多进程部署
├── 数据库
│   ├── MySQL主从复制
│   └── Redis哨兵模式
└── 容器化
    └── Docker Compose编排
```

### 8.3 Docker部署
```yaml
services:
  frontend:
    - Nginx + Vue构建产物
  backend:
    - Python FastAPI应用
  mysql:
    - MySQL 8.0
  redis:
    - Redis 7.0
  vector-db:
    - Chroma/Milvus
```

---

## 9. 项目里程碑

### 第一阶段（2周）- 基础框架搭建
- 前后端项目初始化
- 数据库设计与创建
- 用户认证系统
- 基础对话功能

### 第二阶段（2周）- 核心功能开发
- 通义千问集成
- 流式对话实现
- 对话历史管理
- 前端UI完善

### 第三阶段（3周）- RAG功能开发
- 知识库管理
- 文档上传处理
- 向量化存储
- RAG问答实现

### 第四阶段（3周）- Agent功能开发
- Agent框架搭建
- 工具集开发
- 任务执行引擎
- 执行过程可视化

### 第五阶段（2周）- 测试与优化
- 功能测试
- 性能优化
- 安全加固
- 文档编写

---

## 10. 风险与挑战

### 10.1 技术风险
- 大模型API稳定性和响应速度
- 向量数据库性能优化
- 大文件处理内存占用
- 并发请求处理能力

### 10.2 解决方案
- API调用失败重试机制
- 向量数据库索引优化
- 文件分块异步处理
- 使用消息队列处理高并发

### 10.3 成本控制
- API调用Token消耗监控
- 用户使用配额限制
- 缓存策略减少重复调用
- 向量数据库存储优化

---

## 11. 后续扩展方向

### 11.1 功能扩展
- 多模态支持（图片、语音）
- 多人协作对话
- 知识图谱集成
- 工作流编排
- 插件市场

### 11.2 技术升级
- 支持更多大模型（GPT、Claude等）
- 本地模型部署选项
- 微调模型支持
- 分布式部署

### 11.3 商业化
- 用户订阅体系
- API调用计费
- 企业版功能
- SaaS服务

---

## 12. 附录

### 12.1 参考文档
- LangChain官方文档：https://python.langchain.com/
- 通义千问API文档：https://help.aliyun.com/zh/dashscope/
- FastAPI文档：https://fastapi.tiangolo.com/
- Vue 3文档：https://vuejs.org/

### 12.2 开发规范
- 代码风格：PEP 8 (Python) / ESLint (JavaScript)
- Git提交规范：Conventional Commits
- API文档：OpenAPI 3.0
- 注释规范：完整的函数和类注释

### 12.3 联系方式
- 项目负责人：[待填写]
- 技术负责人：[待填写]
- 产品经理：[待填写]

---

**文档版本**: v1.1
**创建日期**: 2025-12-09
**最后更新**: 2026-01-27
**文档状态**: 已评审

## 变更记录

| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 2025-12-09 | v1.0 | 初始版本 | - |
| 2026-01-27 | v1.1 | Agent模块重大调整：<br>1. 扩充内置工具从3种到6种（新增file_operations、data_analysis、api_call）<br>2. 移除自定义工具创建功能（2.4.3节）<br>3. 简化为"内置工具+启用/禁用"模式<br>4. 更新API接口设计（5.4节）<br>5. 更新UI设计说明（6.2.3节）<br>6. 新增流式执行接口支持 | Claude Code |
