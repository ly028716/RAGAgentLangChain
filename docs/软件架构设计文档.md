# AI智能助手系统 - 软件架构设计文档

**文档版本**：v1.0  
**创建日期**：2026-01-17  
**适用范围**：AI 智能助手系统（Web 前端 + FastAPI 后端 + MySQL/Redis/向量库 + LLM）

## 1. 背景与目标

### 1.1 背景

系统面向企业内部/团队用户，提供基于大语言模型（通义千问）的智能对话能力，并通过 RAG（检索增强生成）与 Agent（工具调用/任务执行）扩展到知识检索与自动化任务执行。

### 1.2 目标

- 支持用户体系与鉴权（JWT、登录态、风控、配额）
- 支持多轮对话与流式输出，提供对话管理（历史、导出、软删除、自动命名）
- 支持知识库与文档管理，提供异步处理流水线（提取→分块→向量化→入向量库）
- 支持 RAG 查询（多知识库联合检索、引用/相似度返回、低延迟）
- 支持 Agent 工具管理与任务执行（ReAct、多步记录、过程可视化）
- 提供系统管理能力（模型/向量库/缓存配置、密钥安全存储、统计与健康检查、可观测性）

### 1.3 非目标

- 商业化计费/订阅体系与企业版权限矩阵（可作为后续扩展）
- 多模态（图片/语音）、工作流编排与插件市场（可作为后续扩展）

## 2. 架构原则

- 分层清晰：API（路由）→ Service（业务编排）→ Repository（数据访问）→ Model（领域数据）→ Core/Integration（基础设施与第三方集成）
- 低耦合可扩展：LLM/Embedding/向量库/工具集均提供可替换的封装层
- 安全默认开启：鉴权、输入校验、限流、敏感信息加密存储与脱敏返回
- 可观测可运维：请求链路标识、指标、日志、慢查询与后台任务可追踪
- 兼容演进：API 版本化（/api/v1），新增字段/接口优先保持向后兼容

## 3. 系统上下文（Context）

### 3.1 外部依赖

- LLM/Embedding：通义千问（DashScope）
- 数据存储：MySQL（业务数据）、Redis（缓存/风控/限流/分布式状态）、向量数据库（Chroma 为主，可扩展到 Milvus）
- 部署：Nginx（前端静态与反向代理）、Docker Compose（开发/生产编排）

### 3.2 上下文关系图（简化）

```text
┌──────────────┐        HTTPS        ┌──────────────────────┐
│   Browser    │  ────────────────►  │  Nginx / ReverseProxy │
└──────────────┘                     └──────────┬───────────┘
                                                │ /api/v1
                                                ▼
                                     ┌──────────────────────┐
                                     │    FastAPI Backend    │
                                     ├─────────┬────────────┤
                                     │ Service │ Integration │
                                     └──┬───┬──┴─────┬──────┘
                                        │   │        │
                                        ▼   ▼        ▼
                                    ┌────┐ ┌─────┐ ┌────────┐
                                    │MySQL│ │Redis│ │VectorDB│
                                    └────┘ └─────┘ └────────┘
                                                       │
                                                       ▼
                                                   ┌────────┐
                                                   │Embedding│
                                                   └────────┘
                                                       │
                                                       ▼
                                                   ┌────────┐
                                                   │  LLM   │
                                                   └────────┘
```

## 4. 总体架构（Logical View）

### 4.1 前端架构（Vue 3 + TS + Element Plus）

- UI 层（Views/Components）：对话页、知识库页、Agent 页、系统设置等
- 状态层（Pinia Stores）：鉴权状态、对话状态、知识库状态、Agent 状态
- API 层（Axios Client + Modules）：按业务模块封装 REST 调用与 token 注入/刷新
- 交互通道：
  - SSE：用于对话/Agent/RAG 的流式内容展示
  - WebSocket：作为可选增强通道，用于任务过程事件推送/订阅（如果启用）

### 4.2 后端架构（FastAPI + SQLAlchemy + LangChain）

后端在代码层面遵循以下模块划分：

- `app/api/v1`：API 路由层（认证、对话、知识库、文档、RAG、Agent、系统等）
- `app/services`：业务编排层（跨仓储、跨第三方调用的流程组织）
- `app/repositories`：数据访问层（封装 CRUD、分页、状态流转、事务边界）
- `app/models`：ORM 模型与领域枚举（用户、对话、文档、工具、执行记录、配额等）
- `app/core`：基础设施（DB、Redis、LLM、向量库、安全、配置、重试、超时）
- `app/langchain_integration`：RAG 链路与 Agent 执行器（LangChain 适配、回调记录、内置工具）
- `app/tasks`：定时任务与后台任务（配额重置、清理、文档处理等）
- `app/middleware`：跨切面能力（请求 ID、异常处理、限流、Prometheus 采集等）
- `app/websocket`：WebSocket 连接管理与处理器（用于事件推送的可选通道）

### 4.3 分层调用关系

```text
Client
  │
  ▼
API Router (FastAPI)  ──►  Schema/DTO（Pydantic）
  │
  ▼
Service（业务编排：鉴权/配额校验/流程编排）
  │
  ├────────────► Repository（数据访问：MySQL）
  │
  ├────────────► Core（Redis/限流/重试/日志/配置）
  │
  └────────────► LangChain Integration（LLM/Embedding/VectorDB）
```

## 5. 关键模块设计

### 5.1 认证与鉴权（Auth）

- 认证方式：JWT（Access Token + Refresh Token）
- 密码存储：bcrypt（工作因子要求不低于既定安全基线）
- 风控：连续失败锁定（Redis 记录锁定事件与 TTL）
- 鉴权落点：
  - REST：`Authorization: Bearer <token>`
  - SSE：沿用 REST 鉴权（同 token 规则）
  - WebSocket（可选）：查询参数携带 token（服务端校验）

### 5.2 对话（Conversation/Chat）

- 数据模型：
  - `conversations`：对话元数据（标题、更新时间、软删除）
  - `messages`：消息明细（role、content、token、时间戳）
  - `api_usage`：调用统计与成本归集（按用户/类型/时间聚合）
- 流式输出：
  - 后端：SSE 返回分片内容（首字响应目标 < 3s）
  - 前端：实时渲染（Markdown + 代码高亮）
- 约束：
  - 每次生成均需记录 token 消耗（消息表与统计表/视图）
  - 首条用户消息后自动生成对话标题（≤20 字）

### 5.3 知识库与文档（Knowledge Base / Documents）

- 知识库：按用户隔离，支持扩展到共享/授权（权限模型见“待决事项”）
- 文档管理：
  - 上传：限制格式与大小（≤10MB），保存文件并落库
  - 处理：异步流水线
    1) 文本提取（按格式适配）
    2) 分块（RecursiveCharacterTextSplitter 或可配置策略）
    3) 向量化（Embedding）
    4) 入库（VectorDB 按知识库隔离 collection/namespace）
  - 状态：处理中/已完成/失败，失败需记录错误原因与可重试策略
  - 删除：需要清理文件、数据库记录与向量库相关向量
- 进度回传：
  - 优先：API 轮询文档状态 + SSE（如设计为流式进度）
  - 可选：WebSocket 推送任务事件

### 5.4 RAG 服务（RAG）

- 检索策略：
  - 默认 topK=5，相似度检索目标 < 1s
  - 支持多知识库联合检索（多 collection 检索后合并排序）
- 响应内容：
  - 生成答案
  - 相关片段（chunk 内容）
  - 来源（文档名/文档 ID/片段 ID）
  - 相似度评分（归一化策略需在接口契约中固定）
- 上下文记忆：
  - 支持对话历史 memory（ConversationBufferMemory）用于多轮追问

### 5.5 Agent 服务（Agent）

- 工具体系：
  - 内置工具：搜索/计算器/天气/文件/数据分析/API 调用等
  - 自定义工具：CRUD + 配置校验 + 启用/禁用控制
- 执行器：
  - ReAct 规划与执行（Thought/Action/Observation 过程记录）
  - steps 持久化：工具名称、输入参数、输出结果、推理片段（需考虑脱敏与合规）
- 过程可视化：
  - REST/SSE：边执行边返回中间步骤，前端可实时渲染执行轨迹
  - WebSocket（可选）：事件推送/订阅

### 5.6 配额与统计（Quota/Stats）

- 配额粒度：按用户月度 token 配额
- 扣减路径：对话与 RAG/Agent 调用完成后记录与扣减
- 重置策略：每月 1 日定时任务重置配额
- 超额处理：配额不足返回 403，并给出明确提示与可重试建议

## 6. 数据架构（Data View）

### 6.1 核心数据对象

- 用户：注册信息、密码哈希、登录时间、状态
- 对话与消息：对话元数据、消息明细、token 统计
- 知识库与文档：知识库元信息、文档元信息、处理状态与错误信息
- Agent：工具定义与配置、执行记录（steps/result/status）
- 配额与使用统计：用户配额、API 使用记录（可按需聚合）

### 6.2 表关系（概念）

```text
users 1 ── n conversations 1 ── n messages
users 1 ── n knowledge_bases 1 ── n documents
users 1 ── n api_usage
users 1 ── n agent_executions
agent_tools 1 ── n agent_executions (steps 引用工具名/ID)
users 1 ── 1 quota (或 1 ── n quota_records 按月分区)
```

### 6.3 数据一致性与事务

- 创建对话/消息：对话与消息落库在同一事务中提交（失败回滚）
- 文档上传：文件保存与文档记录创建需具备幂等与失败补偿策略
- 文档删除：清理顺序建议“向量库→文件→DB”，并在失败时记录可重试任务

## 7. 运行时视图（Runtime View）

### 7.1 登录与刷新

1) 用户登录成功返回 access/refresh  
2) 前端请求携带 access token  
3) access 过期：触发 refresh，成功后重试原请求  
4) refresh 失败：回到登录态

### 7.2 流式对话（SSE）

1) 校验鉴权与配额  
2) 写入用户消息  
3) 调用 LLM 流式生成  
4) 分片通过 SSE 推送给前端  
5) 生成完成：写入 assistant 消息、记录 token 与 usage、更新对话标题/时间

### 7.3 文档上传与处理

1) 上传文件→保存→创建文档记录（处理中）  
2) 后台任务提取文本→分块→向量化→写入向量库  
3) 成功：更新状态与分块数量；失败：记录错误信息  
4) 前端查询文档状态/进度并展示

### 7.4 RAG 查询

1) 校验鉴权与配额  
2) 向量检索（单库/多库）  
3) 组装上下文→调用 LLM 生成答案  
4) 返回答案 + 引用片段 + 来源 + 相似度

### 7.5 Agent 任务执行

1) 校验鉴权与配额  
2) 创建执行记录（执行中）  
3) ReAct 规划与多步工具调用（记录 steps）  
4) 过程实时回传（SSE/可选 WebSocket）  
5) 完成：更新状态与结果；失败：记录错误信息

## 8. 部署架构（Deployment View）

### 8.1 开发环境

- 前端：Vite Dev Server
- 后端：Uvicorn（热更新）
- MySQL/Redis/向量库：本地或 Docker

### 8.2 生产环境（推荐）

- Nginx：
  - 提供前端静态资源
  - 反向代理到后端 `/api/v1`
  - 透传 SSE（注意禁用缓冲与设置合适超时）
- 后端：
  - Gunicorn + Uvicorn Workers（多进程）
  - 水平扩展：无状态 API 层，状态放入 MySQL/Redis/向量库
- 数据层：
  - MySQL 主从/备份策略
  - Redis 哨兵或集群
  - 向量库按容量与检索延迟做资源评估

## 9. 安全设计

- 密码：bcrypt 哈希存储，不记录明文
- JWT：短期 access + 长期 refresh；敏感接口强制鉴权
- API 密钥：AES-256 加密存储；读取时脱敏返回
- 输入校验：Pydantic 校验 + 服务端二次校验（文件类型/大小/字段范围）
- 防护：SQL 注入（ORM/参数化）、XSS（前端渲染安全策略）、CORS 策略、速率限制
- 审计：认证失败与账户锁定事件记录，可用于风控审计

## 10. 性能与可靠性

- 关键指标目标：
  - SSE 首字响应 < 3s
  - 文档处理 < 30s/MB（与硬件/并发相关，需压测校准）
  - 向量检索 < 1s（topK=5 基线）
  - 数据库查询 < 500ms（慢查询记录与索引优化）
- 重试与超时：
  - LLM 调用失败：指数退避重试（上限次数可配置）
  - 外部依赖：超时控制 + 降级策略（例如仅返回检索片段或提示稍后重试）
- 幂等与恢复：
  - 文档处理任务支持重跑/断点续跑（至少可通过状态机驱动重试）
  - 删除操作支持补偿任务，避免“DB 已删但向量未清理”长期堆积

## 11. 可观测性（Observability）

- 日志：
  - 结构化日志 + 请求 ID 贯穿（请求、后台任务、SSE/Agent steps）
  - 慢查询日志（>500ms）
- 指标：
  - Prometheus 采集：请求耗时、错误率、SSE 连接数、任务队列长度（如引入队列）
  - 业务指标：token 消耗、活跃用户、功能热度
- 健康检查：
  - MySQL/Redis/向量库连通性与关键依赖状态

## 12. 扩展性设计

- 模型切换：LLM/Embedding 封装为可配置 Provider（通义千问为默认实现）
- 向量库切换：VectorStoreManager 抽象化，支持 Chroma/Milvus 的配置扩展
- 工具插件化：
  - 内置工具以模块化方式注册
  - 自定义工具以配置驱动（必要时引入安全沙箱与权限隔离）
- 多租户与权限：
  - 以“用户→知识库→文档”作为隔离主线，权限扩展在知识库维度实现

## 13. 风险与待决事项

### 13.1 主要风险

- LLM 稳定性与成本：需要配额、缓存与失败重试策略，并通过统计实现成本可控
- 向量库性能：数据量扩大后检索延迟与索引策略需压测验证
- 大文件与并发：文档处理的 CPU/内存占用可能影响在线请求，需要任务隔离与并发控制

### 13.2 待决事项（建议在评审时确定）

- 知识库权限模型：私有/共享/组织空间，及其授权与审计策略
- WebSocket 通道是否作为主推送机制：与 SSE 的职责划分（对话流 vs 事件流）
- 验证码体系：邮箱/短信验证码的发放渠道、频控、有效期与安全策略
- 导出下载链接策略：存储介质、有效期、鉴权、清理策略

