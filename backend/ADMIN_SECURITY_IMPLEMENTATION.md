# ç®¡ç†å‘˜æƒé™éªŒè¯å’Œå®‰å…¨åŠ å›ºå®æ–½æŠ¥å‘Š

## ğŸ“‹ å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½å®Œæˆäº†AIæ™ºèƒ½åŠ©æ‰‹ç³»ç»Ÿçš„ç®¡ç†å‘˜æƒé™éªŒè¯å’Œå®‰å…¨åŠ å›ºå·¥ä½œï¼ŒåŒ…æ‹¬ï¼š

1. âœ… æ·»åŠ ç®¡ç†å‘˜æƒé™å­—æ®µå’ŒéªŒè¯æœºåˆ¶
2. âœ… æ›´æ–°æ‰€æœ‰éœ€è¦ç®¡ç†å‘˜æƒé™çš„APIç«¯ç‚¹
3. âœ… åˆ›å»ºç®¡ç†å‘˜ç®¡ç†å·¥å…·
4. âœ… ç¼–å†™å®‰å…¨åŠ å›ºæ–‡æ¡£å’ŒæŒ‡å—
5. âœ… åˆ›å»ºå®‰å…¨æ£€æŸ¥è„šæœ¬
6. âœ… æ·»åŠ å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹

---

## ğŸ”§ å®æ–½è¯¦æƒ…

### 1. æ•°æ®åº“æ¨¡å‹æ›´æ–°

**æ–‡ä»¶**: `backend/app/models/user.py`

æ·»åŠ äº† `is_admin` å­—æ®µï¼š

```python
is_admin = Column(
    Boolean,
    default=False,
    nullable=False,
    comment="æ˜¯å¦ä¸ºç®¡ç†å‘˜"
)
```

**æ•°æ®åº“è¿ç§»**: `backend/migrations/versions/003_add_is_admin_field.py`

- æ·»åŠ  `is_admin` å­—æ®µï¼Œé»˜è®¤å€¼ä¸º `False`
- åˆ›å»ºç´¢å¼• `ix_users_is_admin` ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½

### 2. ä¾èµ–æ³¨å…¥æ›´æ–°

**æ–‡ä»¶**: `backend/app/dependencies.py`

æ·»åŠ äº† `get_current_admin_user` å‡½æ•°ï¼š

```python
def get_current_admin_user(
    current_user: User = Depends(get_current_user)
) -> User:
    """
    è·å–å½“å‰ç®¡ç†å‘˜ç”¨æˆ·
    éªŒè¯å½“å‰ç”¨æˆ·æ˜¯å¦å…·æœ‰ç®¡ç†å‘˜æƒé™
    """
    if not current_user.is_admin:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="éœ€è¦ç®¡ç†å‘˜æƒé™"
        )
    return current_user
```

### 3. APIç«¯ç‚¹æ›´æ–°

#### é…é¢ç®¡ç† (`backend/app/api/v1/quota.py`)

- âœ… `PUT /api/v1/quota` - æ›´æ–°ç”¨æˆ·é…é¢ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰
- âœ… `POST /api/v1/quota/reset` - é‡ç½®ç”¨æˆ·é…é¢ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰

**æ›´æ”¹**:
- å°† `Depends(get_current_user)` æ”¹ä¸º `Depends(get_current_admin_user)`
- ç§»é™¤äº† `TODO` æ³¨é‡Š
- æ·»åŠ äº†æ“ä½œæ—¥å¿—è®°å½•

#### ç³»ç»Ÿç®¡ç† (`backend/app/api/v1/system.py`)

- âœ… `GET /api/v1/system/config` - è·å–ç³»ç»Ÿé…ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰
- âœ… `PUT /api/v1/system/config` - æ›´æ–°ç³»ç»Ÿé…ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰
- âœ… `GET /api/v1/system/stats/all` - è·å–å…¨å±€ç»Ÿè®¡ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰
- âœ… `GET /api/v1/system/stats` - è·å–ä½¿ç”¨ç»Ÿè®¡ï¼ˆç®¡ç†å‘˜å¯æŸ¥çœ‹æ‰€æœ‰ï¼Œæ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ï¼‰

**æ›´æ”¹**:
- ç®¡ç†å‘˜ç«¯ç‚¹ä½¿ç”¨ `Depends(get_current_admin_user)`
- å®Œå–„äº†æƒé™æ£€æŸ¥é€»è¾‘
- æ·»åŠ äº†æ“ä½œæ—¥å¿—è®°å½•

### 4. Schemaæ›´æ–°

**æ–‡ä»¶**: `backend/app/schemas/user.py`

åœ¨ `UserProfileResponse` ä¸­æ·»åŠ äº† `is_admin` å­—æ®µï¼š

```python
is_admin: bool = Field(default=False, description="æ˜¯å¦ä¸ºç®¡ç†å‘˜")
```

---

## ğŸ› ï¸ ç®¡ç†å·¥å…·

### 1. åˆ›å»ºç®¡ç†å‘˜è„šæœ¬

**æ–‡ä»¶**: `backend/create_admin.py`

- åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼ˆç”¨æˆ·å: admin, å¯†ç : Admin123456ï¼‰
- è‡ªåŠ¨è®¾ç½® `is_admin = True`
- ç»™äºˆæ›´é«˜çš„é…é¢ï¼ˆ1,000,000 tokens/æœˆï¼‰

**ä½¿ç”¨æ–¹æ³•**:
```bash
python create_admin.py
```

### 2. ç®¡ç†å‘˜ç®¡ç†è„šæœ¬

**æ–‡ä»¶**: `backend/set_admin.py`

åŠŸèƒ½ï¼š
- è®¾ç½®ç”¨æˆ·ä¸ºç®¡ç†å‘˜
- æ’¤é”€ç®¡ç†å‘˜æƒé™
- åˆ—å‡ºæ‰€æœ‰ç®¡ç†å‘˜

**ä½¿ç”¨æ–¹æ³•**:
```bash
# è®¾ç½®ç®¡ç†å‘˜
python set_admin.py <username>

# æ’¤é”€ç®¡ç†å‘˜æƒé™
python set_admin.py --revoke <username>

# åˆ—å‡ºæ‰€æœ‰ç®¡ç†å‘˜
python set_admin.py --list
```

### 3. å®‰å…¨æ£€æŸ¥è„šæœ¬

**æ–‡ä»¶**: `backend/scripts/security_check.py`

è‡ªåŠ¨æ£€æŸ¥ï¼š
- SECRET_KEYå¼ºåº¦
- æ•°æ®åº“é…ç½®
- CORSé…ç½®
- APIå¯†é’¥é…ç½®
- Redisé…ç½®
- å¯†ç ç­–ç•¥
- é€Ÿç‡é™åˆ¶
- JWTé…ç½®
- è°ƒè¯•æ¨¡å¼
- æ–‡ä»¶ä¸Šä¼ é™åˆ¶
- ç®¡ç†å‘˜ç”¨æˆ·

**ä½¿ç”¨æ–¹æ³•**:
```bash
python scripts/security_check.py
```

---

## ğŸ“š æ–‡æ¡£

### 1. å®‰å…¨åŠ å›ºæŒ‡å—

**æ–‡ä»¶**: `backend/SECURITY_HARDENING.md`

å®Œæ•´çš„å®‰å…¨åŠ å›ºæ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- ç®¡ç†å‘˜æƒé™ç®¡ç†
- å¯†ç å®‰å…¨
- APIå®‰å…¨
- æ•°æ®åŠ å¯†
- é€Ÿç‡é™åˆ¶
- æ—¥å¿—å®¡è®¡
- å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•
- å®‰å…¨äº‹ä»¶å“åº”

### 2. å¿«é€Ÿå®‰å…¨é…ç½®æŒ‡å—

**æ–‡ä»¶**: `backend/SECURITY_QUICKSTART.md`

5åˆ†é’Ÿå¿«é€Ÿé…ç½®æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š
- ç”Ÿæˆå¼ºå¯†é’¥
- åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
- ä¿®æ”¹é»˜è®¤å¯†ç 
- é…ç½®CORS
- è¿è¡Œå®‰å…¨æ£€æŸ¥
- éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶

**æ–‡ä»¶**: `backend/tests/test_admin_permissions.py`

æµ‹è¯•è¦†ç›–ï¼š
- âœ… ç®¡ç†å‘˜å¯ä»¥æ›´æ–°é…é¢
- âœ… æ™®é€šç”¨æˆ·ä¸èƒ½æ›´æ–°é…é¢
- âœ… ç®¡ç†å‘˜å¯ä»¥é‡ç½®é…é¢
- âœ… æ™®é€šç”¨æˆ·ä¸èƒ½é‡ç½®é…é¢
- âœ… ç®¡ç†å‘˜å¯ä»¥è·å–ç³»ç»Ÿé…ç½®
- âœ… æ™®é€šç”¨æˆ·ä¸èƒ½è·å–ç³»ç»Ÿé…ç½®
- âœ… ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ç³»ç»Ÿé…ç½®
- âœ… æ™®é€šç”¨æˆ·ä¸èƒ½æ›´æ–°ç³»ç»Ÿé…ç½®
- âœ… ç®¡ç†å‘˜å¯ä»¥è·å–å…¨å±€ç»Ÿè®¡
- âœ… æ™®é€šç”¨æˆ·ä¸èƒ½è·å–å…¨å±€ç»Ÿè®¡
- âœ… æ™®é€šç”¨æˆ·å¯ä»¥è·å–è‡ªå·±çš„ç»Ÿè®¡
- âœ… æ™®é€šç”¨æˆ·ä¸èƒ½è·å–å…¶ä»–ç”¨æˆ·çš„ç»Ÿè®¡
- âœ… ç”¨æˆ·ä¿¡æ¯åŒ…å«is_adminå­—æ®µ
- âœ… ç®¡ç†å‘˜ç«¯ç‚¹éœ€è¦è®¤è¯

**è¿è¡Œæµ‹è¯•**:
```bash
pytest tests/test_admin_permissions.py -v
```

---

## ğŸ“Š å®‰å…¨æ”¹è¿›æ€»ç»“

### å·²å®Œæˆçš„å®‰å…¨æªæ–½

1. **æƒé™æ§åˆ¶**
   - âœ… æ·»åŠ ç®¡ç†å‘˜è§’è‰²
   - âœ… å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
   - âœ… æ‰€æœ‰ç®¡ç†å‘˜ç«¯ç‚¹éƒ½éœ€è¦æƒé™éªŒè¯

2. **å¯†ç å®‰å…¨**
   - âœ… BcryptåŠ å¯†ï¼ˆå·¥ä½œå› å­12ï¼‰
   - âœ… å¯†ç å¼ºåº¦éªŒè¯
   - âœ… ç™»å½•å¤±è´¥é”å®šæœºåˆ¶

3. **APIå®‰å…¨**
   - âœ… JWTä»¤ç‰Œè®¤è¯
   - âœ… ä»¤ç‰Œé»‘åå•æœºåˆ¶
   - âœ… CORSé…ç½®
   - âœ… é€Ÿç‡é™åˆ¶

4. **æ•°æ®å®‰å…¨**
   - âœ… æ•æ„Ÿæ•°æ®åŠ å¯†ï¼ˆAES-256ï¼‰
   - âœ… æ•°æ®è„±æ•
   - âœ… SQLæ³¨å…¥é˜²æŠ¤
   - âœ… XSSé˜²æŠ¤

5. **å®¡è®¡æ—¥å¿—**
   - âœ… ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
   - âœ… ç™»å½•æ—¥å¿—
   - âœ… å®‰å…¨äº‹ä»¶è®°å½•

6. **å·¥å…·å’Œæ–‡æ¡£**
   - âœ… ç®¡ç†å‘˜ç®¡ç†å·¥å…·
   - âœ… å®‰å…¨æ£€æŸ¥è„šæœ¬
   - âœ… å®Œæ•´çš„å®‰å…¨æ–‡æ¡£
   - âœ… å¿«é€Ÿé…ç½®æŒ‡å—

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åº”ç”¨æ•°æ®åº“è¿ç§»

```bash
cd backend
alembic upgrade head
```

è¿™å°†æ·»åŠ  `is_admin` å­—æ®µåˆ° `users` è¡¨ã€‚

### 2. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·

```bash
# æ–¹æ³•1: ä½¿ç”¨è„šæœ¬
python create_admin.py

# æ–¹æ³•2: è®¾ç½®ç°æœ‰ç”¨æˆ·
python set_admin.py <username>
```

### 3. ä¿®æ”¹é»˜è®¤å¯†ç 

âš ï¸ **é‡è¦**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼

```bash
# é€šè¿‡APIä¿®æ”¹
curl -X PUT http://localhost:8000/api/v1/auth/password \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"old_password": "Admin123456", "new_password": "YourStrongPassword123!"}'
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# ç”Ÿæˆå¼ºå¯†é’¥
SECRET_KEY=$(python -c "import secrets; print(secrets.token_hex(32))")

# é…ç½®CORSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
CORS_ORIGINS=https://yourdomain.com

# å…³é—­è°ƒè¯•æ¨¡å¼
DEBUG=False
```

### 5. è¿è¡Œå®‰å…¨æ£€æŸ¥

```bash
python scripts/security_check.py
```

ç¡®ä¿æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡ã€‚

### 6. è¿è¡Œæµ‹è¯•

```bash
pytest tests/test_admin_permissions.py -v
```

ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚

---

## ğŸ“ APIå˜æ›´è¯´æ˜

### éœ€è¦ç®¡ç†å‘˜æƒé™çš„ç«¯ç‚¹

ä»¥ä¸‹ç«¯ç‚¹ç°åœ¨éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæ™®é€šç”¨æˆ·è®¿é—®å°†è¿”å› `403 Forbidden`:

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/v1/quota` | PUT | æ›´æ–°ç”¨æˆ·é…é¢ |
| `/api/v1/quota/reset` | POST | é‡ç½®ç”¨æˆ·é…é¢ |
| `/api/v1/system/config` | GET | è·å–ç³»ç»Ÿé…ç½® |
| `/api/v1/system/config` | PUT | æ›´æ–°ç³»ç»Ÿé…ç½® |
| `/api/v1/system/stats/all` | GET | è·å–å…¨å±€ç»Ÿè®¡ |

### å“åº”å˜æ›´

ç”¨æˆ·ä¿¡æ¯å“åº”ä¸­æ–°å¢ `is_admin` å­—æ®µï¼š

```json
{
  "id": 1,
  "username": "admin",
  "email": "admin@example.com",
  "is_admin": true,
  "is_active": true,
  "created_at": "2025-01-16T10:00:00Z"
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“è¿ç§»

åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨è¿ç§»å‰ï¼š
- å¤‡ä»½æ•°æ®åº“
- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»
- é€‰æ‹©ä½å³°æ—¶æ®µæ‰§è¡Œ

### 2. ç°æœ‰ç”¨æˆ·

è¿ç§»åï¼Œæ‰€æœ‰ç°æœ‰ç”¨æˆ·çš„ `is_admin` é»˜è®¤ä¸º `False`ã€‚éœ€è¦æ‰‹åŠ¨è®¾ç½®ç®¡ç†å‘˜ï¼š

```bash
python set_admin.py <username>
```

### 3. APIå®¢æˆ·ç«¯æ›´æ–°

å‰ç«¯éœ€è¦æ›´æ–°ï¼š
- å¤„ç† `403 Forbidden` å“åº”
- æ˜¾ç¤º `is_admin` çŠ¶æ€
- æ ¹æ®æƒé™æ˜¾ç¤º/éšè—ç®¡ç†åŠŸèƒ½

### 4. é»˜è®¤å¯†ç 

âš ï¸ **ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç«‹å³ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼**

---

## ğŸ”„ åç»­å·¥ä½œ

### å»ºè®®çš„æ”¹è¿›

1. **ç»†ç²’åº¦æƒé™**
   - å®ç°æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
   - æ·»åŠ è§’è‰²ç®¡ç†ï¼ˆè¶…çº§ç®¡ç†å‘˜ã€æ™®é€šç®¡ç†å‘˜ç­‰ï¼‰
   - å®ç°æƒé™ç»„

2. **å®¡è®¡å¢å¼º**
   - æ·»åŠ æ›´è¯¦ç»†çš„æ“ä½œæ—¥å¿—
   - å®ç°æ—¥å¿—æŸ¥è¯¢ç•Œé¢
   - æ·»åŠ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

3. **å®‰å…¨ç›‘æ§**
   - å®æ—¶å®‰å…¨äº‹ä»¶ç›‘æ§
   - å¼‚å¸¸ç™»å½•å‘Šè­¦
   - è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ

4. **å¤šå› ç´ è®¤è¯**
   - æ·»åŠ 2FAæ”¯æŒ
   - çŸ­ä¿¡éªŒè¯ç 
   - TOTPè®¤è¯

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼š

1. æŸ¥çœ‹æ–‡æ¡£ï¼š
   - [SECURITY_HARDENING.md](SECURITY_HARDENING.md)
   - [SECURITY_QUICKSTART.md](SECURITY_QUICKSTART.md)

2. è¿è¡Œå®‰å…¨æ£€æŸ¥ï¼š
   ```bash
   python scripts/security_check.py
   ```

3. æŸ¥çœ‹æµ‹è¯•ï¼š
   ```bash
   pytest tests/test_admin_permissions.py -v
   ```

---

**å®æ–½æ—¥æœŸ**: 2025-01-16  
**å®æ–½äººå‘˜**: Backend Agent  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
